###
## React App
###
FROM node:16-bullseye-slim AS nodebuilder

ARG USE_PROXY
ARG PROXY_URL

# Add a work directory
WORKDIR /app
# Cache and Install dependencies
COPY package.json .
COPY tsconfig.json .

# Install
RUN yarn install
# Copy app files
COPY craco.config.js .
# Add folders
COPY src ./src
COPY public ./public

# set env vars for React
ENV REACT_APP_USE_PROXY $USE_PROXY
ENV REACT_APP_PROXY_URL $PROXY_URL

# Build the app
RUN yarn build

###
## Caddy Web Server & Run proxy binary
###
FROM caddy:alpine as production

# Add your Caddyfile
COPY Caddyfile /etc/caddy/Caddyfile
# Copy built assets from builder
COPY --from=nodebuilder /app/build /usr/share/caddy/html

# Expose port
EXPOSE 8080


